<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Flushing content blocks with Rails 4 - Lucas Mazza</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=0">    
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">



  

<link href="/css/index.min.482157b608992a35db84e964ec0125074bb98514a7def59b7e41801e0466964a.css" rel="stylesheet" />
      <meta name="description" content="Old trick with the Action Pack `content_for` helper"/>
      <meta property="og:title" content="Flushing content blocks with Rails 4"/>
      <meta property="og:type" content="website"/>
      <meta property="og:url" content="https://lucasmazza.website/posts/2012-06-27-flushing-content-blocks-with-rails-4/"/>
      
      <meta property="og:description" content="Old trick with the Action Pack `content_for` helper"/>

      <meta name="twitter:card" content="summary"/>
      <meta name="twitter:site" content="@lucasmazza"/>
      <meta name="twitter:creator" content="@lucasmazza"/>

      
  </head>
  
    <body>
  

    
  <div class="py-4 border-b border-slate-300 print:hidden">
  <div class="relative flex mx-auto lg:w-4/5 px-4 lg:p-0">
    <h1 class="flex mr-auto items-center">
      <img src="/images/lucas.jpg" alt="Lucas's face" class="mr-1 w-12 h-12 lg:w-8 lg:h-8 rounded-md">
      <a href="https://lucasmazza.website/" class="font-extrabold text-2xl text-green-700 whitespace-nowrap">Lucas Mazza</a>
    </h1>

    <div class="lg:hidden">
			<button id="menu-action" class="navbar-burger flex items-center text-green-700 p-3">
				<svg class="block h-8 w-8 fill-current" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
					<title>Mobile menu</title>
					<path d="M0 3h20v2H0V3zm0 6h20v2H0V9zm0 6h20v2H0v-2z"></path>
				</svg>
			</button>
		</div>
    <ul id="menu-target" class="hidden absolute top-full left-0 w-screen divide-y border-y bg-white lg:border-none lg:divide-none lg:static lg:flex lg:mx-auto lg:items-center lg:w-auto lg:space-x-6 lg:gap-3">
      
      
        <li class="p-4 text-xl lg:p-0 lg:text-base">
          <a href="https://lucasmazza.website/about/" class="hover:underline hover:text-green-900 ">About me</a>
        </li>
      
        <li class="p-4 text-xl lg:p-0 lg:text-base">
          <a href="https://lucasmazza.website/posts/" class="hover:underline hover:text-green-900 ">Posts</a>
        </li>
      
        <li class="p-4 text-xl lg:p-0 lg:text-base">
          <a href="https://lucasmazza.website/talks/" class="hover:underline hover:text-green-900 ">Presentations</a>
        </li>
      
        <li class="p-4 text-xl lg:p-0 lg:text-base">
          <a href="https://lucasmazza.website/htmlcss-exemplos" class="hover:underline hover:text-green-900 ">Livro HTML5 e CSS 3 →</a>
        </li>
      
        <li class="p-4 text-xl lg:p-0 lg:text-base">
          <a href="https://lucasmazza.notion.site/lucasmazza/Receitas-79a5a48a2350465dad3c57ba866f95d4" class="hover:underline hover:text-green-900 ">Receitas →</a>
        </li>
      
    </ul>
  </div>
</div>

  

  <div class="mx-auto lg:w-7/12 px-4 mt-4 lg:mt-8 lg:p-0">
    <div class="mb-8 lg:flex items-center">
      
        <h1 class="font-extrabold text-4xl">Flushing content blocks with Rails 4</h1>
      

      
        <span class="inline-flex items-center text-sm mr-2 lg:mr-4 whitespace-nowrap ml-auto text-green-900">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" />
          </svg>
          Published on Jun 27, 2012
        </span>
      
    </div>
    <article class="content-body pb-8">
      <p>Besides the big and shiny features that Rails 4 holds, there&rsquo;s a lot of small improvements on several other sections of the Rails framework - helpers, core extensions, app configurations and more - that might not even hit the Changelogs but will somehow make our lifes easier in the future. One of these hidden gems that I&rsquo;ve found recently is an improvement on the <code>content_for</code> helper to flush and replace previous chunks of HTML with new ones.</p>
<h3 id="the-content_for-that-we-are-used-to">The <code>content_for</code> that we are used to</h3>
<p>The <code>content_for</code> method is an old friend of every Rails developer, and it&rsquo;s a pretty simple and flexible helper. You can store a chunk of HTML from a String or a block, and grab it somewhere else in your views or <code>yield</code> it directly into your templates. It&rsquo;s a pretty handy trick to move data from your views into your layouts, like page titles, custom meta tags or specific <code>script</code> tags that your page needs to include.</p>
<pre tabindex="0"><code class="language-erb" data-lang="erb"># On your &#39;application.html.erb&#39; layout, inside the &#39;&lt;head&gt;&#39; tag.
&lt;%= yield :metatags %&gt;

# Then, into a specific view
&lt;% content_for :metatags do %&gt;
  &lt;meta property=&#34;og:image&#34; content=&#34;http://example.com/image.jpg&#34; /&gt;
&lt;% end %&gt;
</code></pre><p>Multiple calls of the <code>content_for</code> helper using the same identifier will concatenate them and output them together when you read it back on your views, as:</p>
<pre tabindex="0"><code class="language-erb" data-lang="erb">&lt;% content_for :example, &#34;This will be rendered&#34; %&gt;
&lt;% content_for :example do %&gt;
  &lt;h1&gt;This will be rendered too!&lt;/h1&gt;
&lt;% end %&gt;
</code></pre><p>On some scenarios this behavior might not be desired, and with Rails 4 you can flush out the stored pieces of an identifier and replace it instead of adding more content to it: using the <code>flush: true</code> option. The <a href="https://github.com/rails/rails/pull/4226">first implementation</a> used an extra <code>true</code> argument, but <a href="https://github.com/rails/rails/pull/7150">we changed</a> to use a Hash instead, so the <code>flush</code> key can express better the behavior we&rsquo;re expecting.</p>
<pre tabindex="0"><code class="language-erb" data-lang="erb">&lt;% content_for :example, &#34;This will be rendered&#34; %&gt;
&lt;% content_for :example, flush: true do %&gt;
  &lt;h1&gt;But this will override everything on the &#39;:example&#39; block.&lt;/h1&gt;
&lt;% end %&gt;
</code></pre><h3 id="the-gallery-situation">The gallery situation</h3>
<p>I&rsquo;ve stumbled upon this on a recent project, where we had a somewhat classic scenario: a partial named <code>_gallery</code>, responsible for rendering the piece of HTML to display a gallery of images that also supplies a <code>content_for</code> block with a <code>script</code> tag to include the required libraries to put the gallery to work.</p>
<pre tabindex="0"><code class="language-erb" data-lang="erb">&lt;section class=&#34;gallery&#34;&gt;
  &lt;!-- a truckload of HTML tags --&gt;
&lt;/section&gt;
&lt;% content_for :scripts, javascript_include_tag(&#39;gallery&#39;) %&gt;
</code></pre><p>It works like a charm. But with an updated requirement we had the case where multiple galleries could be present on the same page, rendering the <code>_gallery</code> partial several times. The required HTML would be present, but the <code>gallery.js</code> script would be included multiple times into the rendered page. Instead of working this out using instance variables to check that the partial was rendered at least once, we could let Rails do all the hard work for us, using the <code>flush</code> option when including the <code>gallery.js</code> script.</p>
<pre tabindex="0"><code class="language-erb" data-lang="erb">&lt;section class=&#34;gallery&#34;&gt;
  &lt;!-- a truckload of HTML tags --&gt;
&lt;/section&gt;
&lt;% # We can render this partial several times and this script will be included just once %&gt;
&lt;% content_for :scripts, javascript_include_tag(&#39;gallery&#39;), flush: true %&gt;
</code></pre><h3 id="back-to-the-present-rails-32">Back to the present: Rails 3.2</h3>
<p>Well, while this seems to be a perfect solution to my problem, this feature isn&rsquo;t available on Rails 3.2 or on the <code>3-2-stable</code> branch - it&rsquo;s only available on the <code>master</code> branch that will be released with Rails 4. But, backporting this feature into a 3.x application is pretty simple, using a helper of your own.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">single_content_for</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">content</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">block</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">@view_flow</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ActiveSupport</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">SafeBuffer</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">new</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">content_for</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">content</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">block</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">end</span>
</span></span></code></pre></div><p>After some source diving into the ActionPack source code we&rsquo;re done - it just needs to replace any present content with a brand new <code>SafeBuffer</code> instance before storing the piece of HTML.</p>
<p>What do you think about this little addition to Rails 4? Can you think of a similar problem that could be solved with this instead of a custom hack?</p>
<blockquote>
<p>This post was originally published at
<a href="http://blog.plataformatec.com.br/2012/07/flushing-content-blocks-with-rails-4/">http://blog.plataformatec.com.br/2012/07/flushing-content-blocks-with-rails-4/</a></p>
</blockquote>

    </article>
  </div>

  <div class="py-8 flex lg:mx-auto lg:w-7/12 border-t border-slate-300 lg:justify-center gap-4 print:hidden">
  <p class="font-xs text-green-900">
    Copyright &copy; 2022 Lucas Mazza
  </p>
</div>


    
  <script defer src="/menu.08b9a569e417578ad09b03e0b4469fe181e7a74b3614ce1f7e2a7b98e7e99f29.js"></script>
  </body>
</html>