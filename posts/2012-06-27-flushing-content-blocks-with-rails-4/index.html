<!DOCTYPE html>
<html lang="en" data-theme=""><head>
    <title> Lucas Mazza | Flushing content blocks with Rails 4 </title>

    
    <meta charset="utf-8"><meta name="generator" content="Hugo 0.74.3" /><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
    <meta name="description" content="Software Engineer, coffee enthusiast, absent blogger">
    
    <link rel="stylesheet"
          href="https://afterhours.io/css/style.min.ec15cff0912041d0dce3a88999b9424990bd24473761645397583776684cdc3b.css"
          integrity="sha256-7BXP8JEgQdDc46iJmblCSZC9JEc3YWRTl1g3dmhM3Ds="
          crossorigin="anonymous"
          type="text/css">
    <link rel="stylesheet"
          href="https://afterhours.io/css/overrides.bd79f32609bb701f0b5ec583c078889436f3d2ebce0b80eca8602417869948ae.css"
          integrity="sha256-vXnzJgm7cB8LXsWDwHiIlDbz0uvOC4DsqGAkF4aZSK4="
          crossorigin="anonymous"
          type="text/css"><link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"
          integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">

    
    <link rel="shortcut icon" href="https://afterhours.io/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" sizes="180x180" href="https://afterhours.io/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://afterhours.io/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://afterhours.io/favicon-16x16.png">

    <link rel="canonical" href="https://afterhours.io/posts/2012-06-27-flushing-content-blocks-with-rails-4/">

    
    
    
    
    <script type="text/javascript"
            src="https://afterhours.io/js/anatole-header.min.e782db136ec18d105a4552702eac49f4620d6867da3fbf808bd53e806c96be6e.js"
            integrity="sha256-54LbE27BjRBaRVJwLqxJ9GINaGfaP7&#43;Ai9U&#43;gGyWvm4="
            crossorigin="anonymous"></script>
    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Flushing content blocks with Rails 4"/>
<meta name="twitter:description" content="Old trick with the Action Pack content_for helper"/>

</head>
<body><div class="sidebar animated fadeInDown">
    <div class="logo-title">
        <div class="title">
            <img src="https://afterhours.io/images/headshot.jpg" alt="profile picture">
            <h3 title=""><a href="/">Lucas Mazza</a></h3>
            <div class="description">
                <p>Software Engineer, coffee enthusiast, absent blogger</p>
            </div>
        </div>
    </div>
    <ul class="social-links">
        
            <li>
                <a href="https://twitter.com/lucasmazza" rel="me" aria-label="Twitter">
                    <i class="fa fa-2x fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            <li>
                <a href="https://github.com/lucasmazza" rel="me" aria-label="GitHub">
                    <i class="fa fa-2x fa-github" aria-hidden="true"></i>
                </a>
            </li>
        
            <li>
                <a href="https://www.instagram.com/lucasmazza" rel="me" aria-label="instagram">
                    <i class="fa fa-2x fa-instagram" aria-hidden="true"></i>
                </a>
            </li>
        
            <li>
                <a href="mailto:lucasmazza@hey.com" rel="me" aria-label="e-mail">
                    <i class="fa fa-2x fa-envelope" aria-hidden="true"></i>
                </a>
            </li>
        
    </ul>
    <div class="footer">
        <div class="by_farbox">&copy; Lucas Mazza 2020 </div>
    </div>
</div>
<div class="main">
    <div class="page-top animated fadeInDown">
    <a role="button" class="navbar-burger" data-target="navMenu" aria-label="menu" aria-expanded="false">
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
    </a>
    <ul class="nav" id="navMenu">
        
        
            
            <li><a 
                   href="/"
                        
                   title="">Home</a></li>
        
            
            <li><a 
                   href="/posts/"
                        
                   title="">Posts</a></li>
        
            
            <li><a 
                   href="/talks/"
                        
                   title="">Presentations</a></li>
        
            
            <li><a 
                   href="/about/"
                        
                   title="">About</a></li>
        
            
            <li><a 
                   href="https://afterhours.io/htmlcss-exemplos"
                        
                            target="_blank"
                            rel="noopener noreferrer"
                        
                   title="">Livro HTML5 e CSS 3 (pt-BR)</a></li>
        
            
            <li><a 
                   href="https://www.notion.so/Receitas-79a5a48a2350465dad3c57ba866f95d4"
                        
                            target="_blank"
                            rel="noopener noreferrer"
                        
                   title="">Receitas (pt-BR)</a></li>
        
        
        <li class="theme-switch-item">
            <a class="theme-switch" title="Switch Theme">
                <i class="fa fa-adjust fa-fw" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>

    <div class="autopagerize_page_element">
        <div class="content">
    <div class="post animated fadeInDown">
        <div class="post-content">

            <div class="post-title">
                <h3>Flushing content blocks with Rails 4</h3>
                
            </div>

            <p>Besides the big and shiny features that Rails 4 holds, there&rsquo;s a lot of small improvements on several other sections of the Rails framework - helpers, core extensions, app configurations and more - that might not even hit the Changelogs but will somehow make our lifes easier in the future. One of these hidden gems that I&rsquo;ve found recently is an improvement on the <code>content_for</code> helper to flush and replace previous chunks of HTML with new ones.</p>
<h3 id="the-content_for-that-we-are-used-to">The <code>content_for</code> that we are used to</h3>
<p>The <code>content_for</code> method is an old friend of every Rails developer, and it&rsquo;s a pretty simple and flexible helper. You can store a chunk of HTML from a String or a block, and grab it somewhere else in your views or <code>yield</code> it directly into your templates. It&rsquo;s a pretty handy trick to move data from your views into your layouts, like page titles, custom meta tags or specific <code>script</code> tags that your page needs to include.</p>
<pre><code class="language-erb" data-lang="erb"># On your 'application.html.erb' layout, inside the '&lt;head&gt;' tag.
&lt;%= yield :metatags %&gt;

# Then, into a specific view
&lt;% content_for :metatags do %&gt;
  &lt;meta property=&quot;og:image&quot; content=&quot;http://example.com/image.jpg&quot; /&gt;
&lt;% end %&gt;
</code></pre><p>Multiple calls of the <code>content_for</code> helper using the same identifier will concatenate them and output them together when you read it back on your views, as:</p>
<pre><code class="language-erb" data-lang="erb">&lt;% content_for :example, &quot;This will be rendered&quot; %&gt;
&lt;% content_for :example do %&gt;
  &lt;h1&gt;This will be rendered too!&lt;/h1&gt;
&lt;% end %&gt;
</code></pre><p>On some scenarios this behavior might not be desired, and with Rails 4 you can flush out the stored pieces of an identifier and replace it instead of adding more content to it: using the <code>flush: true</code> option. The <a href="https://github.com/rails/rails/pull/4226">first implementation</a> used an extra <code>true</code> argument, but <a href="https://github.com/rails/rails/pull/7150">we changed</a> to use a Hash instead, so the <code>flush</code> key can express better the behavior we&rsquo;re expecting.</p>
<pre><code class="language-erb" data-lang="erb">&lt;% content_for :example, &quot;This will be rendered&quot; %&gt;
&lt;% content_for :example, flush: true do %&gt;
  &lt;h1&gt;But this will override everything on the ':example' block.&lt;/h1&gt;
&lt;% end %&gt;
</code></pre><h3 id="the-gallery-situation">The gallery situation</h3>
<p>I&rsquo;ve stumbled upon this on a recent project, where we had a somewhat classic scenario: a partial named <code>_gallery</code>, responsible for rendering the piece of HTML to display a gallery of images that also supplies a <code>content_for</code> block with a <code>script</code> tag to include the required libraries to put the gallery to work.</p>
<pre><code class="language-erb" data-lang="erb">&lt;section class=&quot;gallery&quot;&gt;
  &lt;!-- a truckload of HTML tags --&gt;
&lt;/section&gt;
&lt;% content_for :scripts, javascript_include_tag('gallery') %&gt;
</code></pre><p>It works like a charm. But with an updated requirement we had the case where multiple galleries could be present on the same page, rendering the <code>_gallery</code> partial several times. The required HTML would be present, but the <code>gallery.js</code> script would be included multiple times into the rendered page. Instead of working this out using instance variables to check that the partial was rendered at least once, we could let Rails do all the hard work for us, using the <code>flush</code> option when including the <code>gallery.js</code> script.</p>
<pre><code class="language-erb" data-lang="erb">&lt;section class=&quot;gallery&quot;&gt;
  &lt;!-- a truckload of HTML tags --&gt;
&lt;/section&gt;
&lt;% # We can render this partial several times and this script will be included just once %&gt;
&lt;% content_for :scripts, javascript_include_tag('gallery'), flush: true %&gt;
</code></pre><h3 id="back-to-the-present-rails-32">Back to the present: Rails 3.2</h3>
<p>Well, while this seems to be a perfect solution to my problem, this feature isn&rsquo;t available on Rails 3.2 or on the <code>3-2-stable</code> branch - it&rsquo;s only available on the <code>master</code> branch that will be released with Rails 4. But, backporting this feature into a 3.x application is pretty simple, using a helper of your own.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">single_content_for</span>(<span style="color:#0086b3">name</span>, content <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">nil</span>, <span style="color:#000;font-weight:bold">&amp;</span>block)
  <span style="color:#008080">@view_flow</span><span style="color:#000;font-weight:bold">.</span>set(<span style="color:#0086b3">name</span>, <span style="color:#008080">ActiveSupport</span><span style="color:#000;font-weight:bold">::</span><span style="color:#008080">SafeBuffer</span><span style="color:#000;font-weight:bold">.</span>new)
  content_for(<span style="color:#0086b3">name</span>, content, <span style="color:#000;font-weight:bold">&amp;</span>block)
<span style="color:#000;font-weight:bold">end</span>
</code></pre></div><p>After some source diving into the ActionPack source code we&rsquo;re done - it just needs to replace any present content with a brand new <code>SafeBuffer</code> instance before storing the piece of HTML.</p>
<p>What do you think about this little addition to Rails 4? Can you think of a similar problem that could be solved with this instead of a custom hack?</p>
<blockquote>
<p>This post was originally published at
<a href="http://blog.plataformatec.com.br/2012/07/flushing-content-blocks-with-rails-4/">http://blog.plataformatec.com.br/2012/07/flushing-content-blocks-with-rails-4/</a></p>
</blockquote>

        </div>
        <div class="post-footer">
            <div class="info">
                
                
            </div>
        </div>

        
    </div>


        </div>
    </div>
</div>

<script type="text/javascript"
        src="https://afterhours.io/js/jquery.min.86b1e8f819ee2d9099a783e50b49dff24282545fc40773861f9126b921532e4c.js"
        integrity="sha256-hrHo&#43;BnuLZCZp4PlC0nf8kKCVF/EB3OGH5EmuSFTLkw="
        crossorigin="anonymous"></script>




<script type="text/javascript"
        src="https://afterhours.io/js/bundle.min.0f9c74cb78f13d1f15f33daff4037c70354f98acfbb97a6f61708966675c3cae.js"
        integrity="sha256-D5x0y3jxPR8V8z2v9AN8cDVPmKz7uXpvYXCJZmdcPK4="
        crossorigin="anonymous"></script>

<script type="text/javascript"
        src="https://afterhours.io/js/medium-zoom.min.92f21c856129f84aeb719459b3e6ac621a3032fd7b180a18c04e1d12083f8aba.js"
        integrity="sha256-kvIchWEp&#43;ErrcZRZs&#43;asYhowMv17GAoYwE4dEgg/iro="
        crossorigin="anonymous"></script>
</body>

</html>
