<!DOCTYPE html>
<html lang="en" data-theme=""><head>
    <title> Lucas Mazza | Experimenting with explicit contracts with Ruby </title>

    
    <meta charset="utf-8"><meta name="generator" content="Hugo 0.74.3" /><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
    <meta name="description" content="Software Engineer, coffee enthusiast, absent blogger">
    
    <link rel="stylesheet"
          href="https://afterhours.io/css/style.min.ec15cff0912041d0dce3a88999b9424990bd24473761645397583776684cdc3b.css"
          integrity="sha256-7BXP8JEgQdDc46iJmblCSZC9JEc3YWRTl1g3dmhM3Ds="
          crossorigin="anonymous"
          type="text/css">
    <link rel="stylesheet"
          href="https://afterhours.io/css/overrides.bd79f32609bb701f0b5ec583c078889436f3d2ebce0b80eca8602417869948ae.css"
          integrity="sha256-vXnzJgm7cB8LXsWDwHiIlDbz0uvOC4DsqGAkF4aZSK4="
          crossorigin="anonymous"
          type="text/css"><link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"
          integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">

    
    <link rel="shortcut icon" href="https://afterhours.io/favicon.ico" type="image/x-icon">
    <link rel="apple-touch-icon" sizes="180x180" href="https://afterhours.io/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://afterhours.io/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://afterhours.io/favicon-16x16.png">

    <link rel="canonical" href="https://afterhours.io/posts/2016-02-29-experimenting-with-explicit-contracts-with-ruby/">

    
    
    
    
    <script type="text/javascript"
            src="https://afterhours.io/js/anatole-header.min.e782db136ec18d105a4552702eac49f4620d6867da3fbf808bd53e806c96be6e.js"
            integrity="sha256-54LbE27BjRBaRVJwLqxJ9GINaGfaP7&#43;Ai9U&#43;gGyWvm4="
            crossorigin="anonymous"></script>
    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Experimenting with explicit contracts with Ruby"/>
<meta name="twitter:description" content="Bringing design ideas from Elixir projects into Ruby"/>

</head>
<body><div class="sidebar animated fadeInDown">
    <div class="logo-title">
        <div class="title">
            <img src="https://afterhours.io/images/headshot.jpg" alt="profile picture">
            <h3 title=""><a href="/">Lucas Mazza</a></h3>
            <div class="description">
                <p>Software Engineer, coffee enthusiast, absent blogger</p>
            </div>
        </div>
    </div>
    <ul class="social-links">
        
            <li>
                <a href="https://twitter.com/lucasmazza" rel="me" aria-label="Twitter">
                    <i class="fa fa-2x fa-twitter" aria-hidden="true"></i>
                </a>
            </li>
        
            <li>
                <a href="https://github.com/lucasmazza" rel="me" aria-label="GitHub">
                    <i class="fa fa-2x fa-github" aria-hidden="true"></i>
                </a>
            </li>
        
            <li>
                <a href="https://www.instagram.com/lucasmazza" rel="me" aria-label="instagram">
                    <i class="fa fa-2x fa-instagram" aria-hidden="true"></i>
                </a>
            </li>
        
            <li>
                <a href="mailto:email@lucasmazza.website" rel="me" aria-label="e-mail">
                    <i class="fa fa-2x fa-envelope" aria-hidden="true"></i>
                </a>
            </li>
        
    </ul>
    <div class="footer">
        <div class="by_farbox">&copy; Lucas Mazza 2022 </div>
    </div>
</div>
<div class="main">
    <div class="page-top animated fadeInDown">
    <a role="button" class="navbar-burger" data-target="navMenu" aria-label="menu" aria-expanded="false">
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
    </a>
    <ul class="nav" id="navMenu">
        
        
            
            <li><a 
                   href="/"
                        
                   title="">Home</a></li>
        
            
            <li><a 
                   href="/posts/"
                        
                   title="">Posts</a></li>
        
            
            <li><a 
                   href="/talks/"
                        
                   title="">Presentations</a></li>
        
            
            <li><a 
                   href="/about/"
                        
                   title="">About</a></li>
        
            
            <li><a 
                   href="https://afterhours.io/htmlcss-exemplos"
                        
                            target="_blank"
                            rel="noopener noreferrer"
                        
                   title="">Livro HTML5 e CSS 3 (pt-BR)</a></li>
        
            
            <li><a 
                   href="https://lucasmazza.notion.site/Receitas-79a5a48a2350465dad3c57ba866f95d4"
                        
                            target="_blank"
                            rel="noopener noreferrer"
                        
                   title="">Receitas (pt-BR)</a></li>
        
        
        <li class="theme-switch-item">
            <a class="theme-switch" title="Switch Theme">
                <i class="fa fa-adjust fa-fw" aria-hidden="true"></i>
            </a>
        </li>
    </ul>
</div>

    <div class="autopagerize_page_element">
        <div class="content">
    <div class="post animated fadeInDown">
        <div class="post-content">

            <div class="post-title">
                <h3>Experimenting with explicit contracts with Ruby</h3>
                
            </div>

            <p>A few months back, Jos√© Valim <a href="http://blog.plataformatec.com.br/2015/10/mocks-and-explicit-contracts/">started a conversation</a> on overusing mocks and coupling between components. That made me interested on revisiting how I design my code and it has changed my approach to testing a bit in one of our current Ruby projects.</p>
<h2 id="a-tale-of-two-adapters">A Tale of Two Adapters</h2>
<p>Back in November, I worked on integrating a payment gateway from scratch into one of our client projects, through a gem that abstracts the HTTP interface of this external service. On this payment flow we had to first authorize the payment data with the gateway, which would return the transaction data for us to capture the payment in the background and go on with the business logic that depended on a successful payment flow.</p>
<p>If you ever worked on something similar, you probably remember a few rough edges that we need to deal in cases like this: how to test the integration with the right credit card numbers for each possible outcome? Do we have a sandbox available for development and test environments? How can we control the performance and stability costs that this external dependency might bring to our application, and the coupling between the code that supports this core feature and this gem?</p>
<p>Our attempt to handle the coupling and maintenance cost of this dependency was to push all the integration code behind an abstraction layer responsible for dealing with this payment flow logic under a <code>Payments</code> namespace.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#0086b3">require</span> <span style="color:#d14">&#39;gateway-xyz-gem&#39;</span>

<span style="color:#000;font-weight:bold">module</span> <span style="color:#555">Payments</span>
  <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">GatewayXYZ</span>
    <span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">authorize</span>(order, credit_card)
      <span style="color:#998;font-style:italic"># Uses the `Order` details and the user `CreditCard` data to authorize</span>
      <span style="color:#998;font-style:italic"># a new transaction on the XYZ Payment Gateway through the</span>
      <span style="color:#998;font-style:italic"># `gateway-xyz-gem` classes.</span>
    <span style="color:#000;font-weight:bold">end</span>

    <span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">capture</span>(payment_id)
      <span style="color:#998;font-style:italic"># Capture the payment information for a transaction that was previously</span>
      <span style="color:#998;font-style:italic"># authorized.</span>
    <span style="color:#000;font-weight:bold">end</span>
  <span style="color:#000;font-weight:bold">end</span>
<span style="color:#000;font-weight:bold">end</span>
</code></pre></div><p>Somewhere down our <code>orders#create</code> action (but not directly in the controller method itself) we call <code>GatewayXYZ#authorize</code> with the <code>order</code> record and a <code>credit_card</code> value object and our integration with the external service is done.</p>
<p>We might have a nice set of well-defined methods on the <code>GatewayXYZ</code> class but our job on these abstractions is far from done. We might unit test it with something like <a href="https://github.com/bblimke/webmock">WebMock</a> or <a href="https://github.com/vcr/vcr">VCR</a> to handle the external service dependency, but every other piece of our system that interacts with this abstraction will also depend on the external API to work properly - the <code>OrdersController</code>, the background job that captures the payment and the <code>Order</code> model itself that might trigger the initial <code>authorize</code> call. Should we just sprinkle the existing stubs all over our test suite and call it a day?</p>
<p>We added a gateway implementation that mimics the expected behavior of the <code>GatewayXYZ</code> (with the same method signatures as the real gateway) and doesn‚Äôt depend on external resources. It also has a predefined behavior for specific inputs so we can test different code paths of their collaborators based on the test input.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#000;font-weight:bold">module</span> <span style="color:#555">Payments</span>
  <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">Memory</span>
    <span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">authorize</span>(order, credit_card)
      <span style="color:#000;font-weight:bold">if</span> <span style="color:#008080">BAD_CREDIT_CARD_NUMBERS</span><span style="color:#000;font-weight:bold">.</span>include?(credit_card<span style="color:#000;font-weight:bold">.</span>number)
        bad_response
      <span style="color:#000;font-weight:bold">else</span>
        ok_response
      <span style="color:#000;font-weight:bold">end</span>
    <span style="color:#000;font-weight:bold">end</span>
  <span style="color:#000;font-weight:bold">end</span>
<span style="color:#000;font-weight:bold">end</span>
</code></pre></div><h2 id="dealing-with-environment-specific-setups">Dealing with environment specific setups</h2>
<p>Now we need to make our <code>Payments::Memory</code> the go-to implementation for our test cases that depend on our payment abstractions. There are a few different ways we can do this on a Rails app.</p>
<h3 id="railsapplicationconfig"><code>Rails.application.config</code></h3>
<p>We can expose a configuration setting in app that says which implementation it should use, similar to how <code>Action Mailer</code> picks the delivery method for your emails or how <code>Active Job</code> might have different queue adapters for your background jobs.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#998;font-style:italic"># config/application.rb</span>
<span style="color:#008080">Rails</span><span style="color:#000;font-weight:bold">.</span>application<span style="color:#000;font-weight:bold">.</span>config<span style="color:#000;font-weight:bold">.</span>x<span style="color:#000;font-weight:bold">.</span>payment_gateway <span style="color:#000;font-weight:bold">=</span> <span style="color:#008080">Payments</span><span style="color:#000;font-weight:bold">::</span><span style="color:#008080">GatewayXYZ</span>

<span style="color:#998;font-style:italic"># config/environments/test.rb</span>
<span style="color:#008080">Rails</span><span style="color:#000;font-weight:bold">.</span>application<span style="color:#000;font-weight:bold">.</span>config<span style="color:#000;font-weight:bold">.</span>x<span style="color:#000;font-weight:bold">.</span>payment_gateway <span style="color:#000;font-weight:bold">=</span> <span style="color:#008080">Payments</span><span style="color:#000;font-weight:bold">::</span><span style="color:#008080">Memory</span>

<span style="color:#998;font-style:italic"># app/models/order.rb</span>
<span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">Order</span>
  <span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">authorize</span>(credit_card)
    gateway <span style="color:#000;font-weight:bold">=</span> build_gateway
    gateway<span style="color:#000;font-weight:bold">.</span>authorize(<span style="color:#0086b3">self</span>, credit_card)
  <span style="color:#000;font-weight:bold">end</span>

  <span style="color:#000;font-weight:bold">private</span>

  <span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">build_gateway</span>
    klass <span style="color:#000;font-weight:bold">=</span> <span style="color:#008080">Rails</span><span style="color:#000;font-weight:bold">.</span>application<span style="color:#000;font-weight:bold">.</span>config<span style="color:#000;font-weight:bold">.</span>x<span style="color:#000;font-weight:bold">.</span>payment_gateway
    klass<span style="color:#000;font-weight:bold">.</span>new
  <span style="color:#000;font-weight:bold">end</span>
<span style="color:#000;font-weight:bold">end</span>
</code></pre></div><h3 id="modulemattr_accessor-macro"><code>Module.mattr_accessor</code> macro</h3>
<p>You can set a class level macro on the classes that depend on a configurable value and change as you want in your code. This approach can be useful if you want to keep the configuration closer to the implementation that relies on it, instead of jumping between app code and configuration code if you want to debug something or be able to change it during runtime.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#998;font-style:italic"># app/models/order.rb</span>
<span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">Order</span>
  cattr_accessor <span style="color:#990073">:payment_gateway</span> <span style="color:#000;font-weight:bold">do</span>
    <span style="color:#008080">Payments</span><span style="color:#000;font-weight:bold">::</span><span style="color:#008080">GatewayXYZ</span>
  <span style="color:#000;font-weight:bold">end</span>

  <span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">authorize</span>(credit_card)
    gateway <span style="color:#000;font-weight:bold">=</span> payment_gateway<span style="color:#000;font-weight:bold">.</span>new
    gateway<span style="color:#000;font-weight:bold">.</span>authorize(<span style="color:#0086b3">self</span>, credit_card)
  <span style="color:#000;font-weight:bold">end</span>
<span style="color:#000;font-weight:bold">end</span>

<span style="color:#998;font-style:italic"># test/test_helper.rb</span>
<span style="color:#008080">Order</span><span style="color:#000;font-weight:bold">.</span>payment_gateway <span style="color:#000;font-weight:bold">=</span> <span style="color:#008080">Payments</span><span style="color:#000;font-weight:bold">::</span><span style="color:#008080">Memory</span>
</code></pre></div><h2 id="factory-method">Factory method</h2>
<p>This approach is useful when you want to hide away how to create an instance of a gateway implementation, so other classes that depend on it can have a way to just ask for a gateway object without worrying on how to create it.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#998;font-style:italic"># app/models/payments.rb</span>
<span style="color:#000;font-weight:bold">module</span> <span style="color:#555">Payments</span>
  matt_accessor <span style="color:#990073">:gateway</span> <span style="color:#000;font-weight:bold">do</span>
    <span style="color:#008080">Payments</span><span style="color:#000;font-weight:bold">::</span><span style="color:#008080">GatewayXYZ</span>
  <span style="color:#000;font-weight:bold">end</span>

  <span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">build_gateway</span>
    gateway<span style="color:#000;font-weight:bold">.</span>new
  <span style="color:#000;font-weight:bold">end</span>

  <span style="color:#000;font-weight:bold">module_function</span> <span style="color:#990073">:build_gateway</span>
<span style="color:#000;font-weight:bold">end</span>

<span style="color:#998;font-style:italic"># test/test_helper.rb</span>
<span style="color:#008080">Payments</span><span style="color:#000;font-weight:bold">.</span>gateway <span style="color:#000;font-weight:bold">=</span> <span style="color:#008080">Payments</span><span style="color:#000;font-weight:bold">::</span><span style="color:#008080">Memory</span>
</code></pre></div><p>I don‚Äôt believe that there is a Single Way to Do It‚Ñ¢ this kind of dependency injection, so you should feel free to pick a strategy that suits the interfaces you are building and the coding style of your team - I‚Äôm personally a fan of the factory method and the <code>cattr_accessor</code> approaches as they feel more detached from the configuration and closer to the application code, although the configuration way feels more aligned with global APIs from 3rd party gems.</p>
<h2 id="skipping-hash-driven-development">Skipping Hash driven development</h2>
<p>Our <code>GatewayXYZ</code> and <code>Memory</code> implementations have the same methods with the same arguments but there is a second piece of making a uniform API that we need to think about: what those methods should return?</p>
<p>Our <code>authorize</code> needs to return more than a <code>truthy</code>/<code>falsy</code> value, as we need to gather more information about the payment transaction on our end, like the <code>payment_id</code> from the transaction, or a reason of why it might have failed (was the credit card denied? There is invalid data in the request), details for logging or instrumentation, etc. And if we think about implementing this API for multiple services (let&rsquo;s say we need a <code>Payments::PayPal</code> now, for instance), those services will return this data in different formats that we need to normalize so these differences don&rsquo;t leak to the rest of the system.</p>
<p>One might say that a <code>Hash</code> with all this junk would do it, but going that path opens too many doors for inconsistency and bugs as the hash is a weak abstraction that can be mutated anywhere and won&rsquo;t enforce any specific format or requirements on the return values.</p>
<p>For that, we can implement a <code>Payments::Result</code> struct/value object to represent the outcome of our <code>authorize</code> action, and return it from each gateway implementation in our system, enforcing the interface we want to have.</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#000;font-weight:bold">module</span> <span style="color:#555">Payments</span>
  <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">Result</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#008080">Struct</span><span style="color:#000;font-weight:bold">.</span>new(<span style="color:#990073">:payment_id</span>, <span style="color:#990073">:errors</span>)
    <span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">ok?</span>
      errors<span style="color:#000;font-weight:bold">.</span>blank?
    <span style="color:#000;font-weight:bold">end</span>

    <span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">failed?</span>
      <span style="color:#000;font-weight:bold">!</span>ok?
    <span style="color:#000;font-weight:bold">end</span>
  <span style="color:#000;font-weight:bold">end</span>
<span style="color:#000;font-weight:bold">end</span>
</code></pre></div><p>Our <code>Result</code> class has the minimal information that our client code needs, and each gateway is responsible for constructing a <code>Result</code> from its own data. The <code>Memory</code> gateway can do something as straightforward as this:</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#000;font-weight:bold">module</span> <span style="color:#555">Payments</span>
  <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">Memory</span>
    <span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">authorize</span>(order, credit_card)
      <span style="color:#008080">Result</span><span style="color:#000;font-weight:bold">.</span>new(
        <span style="color:#990073">payment_id</span>: <span style="color:#008080">SecureRandom</span><span style="color:#000;font-weight:bold">.</span>hex,
        <span style="color:#990073">errors</span>: <span style="color:#008080">SAMPLE_ERRORS</span><span style="color:#000;font-weight:bold">[</span>credit_card<span style="color:#000;font-weight:bold">.</span>number<span style="color:#000;font-weight:bold">]</span>)
    <span style="color:#000;font-weight:bold">end</span>
  <span style="color:#000;font-weight:bold">end</span>
<span style="color:#000;font-weight:bold">end</span>
</code></pre></div><p>This approach is useful not just for enforcing the interface we want, but also to improve other areas of our code that could use more specific abstractions than a bare <code>Hash</code> instance.</p>
<h2 id="going-forward-with-contracts-and-macros">Going forward with contracts and macros</h2>
<p>This homemade approach for better contracts between our app and this external service can go a long way, but if you want, you can build strict checks on top of your APIs to ensure that your objects are collaborating as you expect. We haven&rsquo;t tried yet, but the <a href="https://github.com/egonSchiele/contracts.ruby">contracts</a> gem looks very interesting if you want that kind of type constraints that are lacking on Ruby.</p>
<p>You can even write your own checks by wrapping methods into type checking proxies, as <a href="https://github.com/refile/refile"><code>refile</code></a> does with its <a href="https://github.com/refile/refile/blob/v0.6.2/lib/refile/backend_macros.rb"><code>Refile::BackendMacros</code></a> module. When <a href="https://github.com/refile/refile/blob/v0.6.2/lib/refile/backend/file_system.rb">extended by a backend implementation</a>, it provides macros to validate the input for methods like <code>#upload(uploadable)</code> or <code>#delete(id)</code>, so custom implementations don&rsquo;t need to worry about validating these arguments on their own.</p>
<blockquote>
<p>This post originally published at
<a href="http://blog.plataformatec.com.br/2016/02/experimenting-with-explicit-contracts-with-ruby/">http://blog.plataformatec.com.br/2016/02/experimenting-with-explicit-contracts-with-ruby/</a></p>
</blockquote>

        </div>
        <div class="post-footer">
            <div class="info">
                
                
            </div>
        </div>

        
    </div>


        </div>
    </div>
</div>

<script type="text/javascript"
        src="https://afterhours.io/js/jquery.min.86b1e8f819ee2d9099a783e50b49dff24282545fc40773861f9126b921532e4c.js"
        integrity="sha256-hrHo&#43;BnuLZCZp4PlC0nf8kKCVF/EB3OGH5EmuSFTLkw="
        crossorigin="anonymous"></script>




<script type="text/javascript"
        src="https://afterhours.io/js/bundle.min.0f9c74cb78f13d1f15f33daff4037c70354f98acfbb97a6f61708966675c3cae.js"
        integrity="sha256-D5x0y3jxPR8V8z2v9AN8cDVPmKz7uXpvYXCJZmdcPK4="
        crossorigin="anonymous"></script>

<script type="text/javascript"
        src="https://afterhours.io/js/medium-zoom.min.92f21c856129f84aeb719459b3e6ac621a3032fd7b180a18c04e1d12083f8aba.js"
        integrity="sha256-kvIchWEp&#43;ErrcZRZs&#43;asYhowMv17GAoYwE4dEgg/iro="
        crossorigin="anonymous"></script>
</body>

</html>
